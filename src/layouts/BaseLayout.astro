---
export interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  canonical?: string;
}

const {
  title = 'TunaCan Deorbit Module - CubeSat Reentry System',
  description = 'TunaCan Labs builds a tuna-can sized drag sail and plasma brake kit that helps CubeSats meet debris mitigation timelines.',
  ogImage = 'https://images.unsplash.com/photo-1446776811953-b23d57bd21aa?q=80&w=1200&auto=format&fit=crop',
  canonical = new URL(Astro.url.pathname, Astro.site).toString()
} = Astro.props as Props;

const siteName = 'ASDS Space Technologies';
const twitter = '@asds-space-technologies';
const lang = 'en';

import '@/styles/globals.css';
---

<html lang={lang} class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href={`${import.meta.env.BASE_URL}favicon.svg`} />
    <link rel="manifest" href={`${import.meta.env.BASE_URL}site.webmanifest`} />

    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="theme-color" content="#60a5fa" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href={canonical} />

    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:url" content={canonical} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content={twitter} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <script type="application/ld+json">
      {JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'Project',
        name: title,
        description,
        url: canonical,
        image: ogImage,
        sponsor: { '@type': 'Organization', name: siteName },
      })}
    </script>
  </head>
  <body class="min-h-full bg-starfield">
    <a href="#content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-black/60 px-3 py-2 rounded-md">Skip to content</a>
    <slot />
    <script>
      (function () {
        const panels = Array.from(document.querySelectorAll('[data-animate]'));
        const supportsMatchMedia = typeof window.matchMedia === 'function';
        const prefersReducedMotion = supportsMatchMedia ? window.matchMedia('(prefers-reduced-motion: reduce)').matches : false;
        const narrowViewport = supportsMatchMedia ? window.matchMedia('(max-width: 768px)').matches : window.innerWidth <= 768;

        if (panels.length) {
          const simpleReveal = prefersReducedMotion || narrowViewport || !('IntersectionObserver' in window);

          if (simpleReveal) {
            panels.forEach((el) => {
              el.classList.add('is-visible');
              el.classList.add('is-active');
              el.classList.remove('is-exiting');
            });
          } else {
            const assignDelays = () => {
              panels.forEach((el, index) => {
                const delay = el.dataset.delay ? Number(el.dataset.delay) : index * 120;
                el.style.setProperty('--sr-delay', Math.min(delay, 480) + 'ms');
                if (el.dataset.slide) {
                  el.style.setProperty('--slide-distance', el.dataset.slide);
                }
              });
            };
            assignDelays();

            let currentActive = null;
            const setActive = (next) => {
              if (!next || currentActive === next) return;

              next.classList.add('is-active');
              next.classList.remove('is-exiting');

              if (currentActive && currentActive !== next) {
                currentActive.classList.remove('is-active');
                if (currentActive.classList.contains('is-visible')) {
                  currentActive.classList.add('is-exiting');
                } else {
                  currentActive.classList.remove('is-exiting');
                }
              }

              currentActive = next;
            };

            const updateState = () => {
              let candidate = null;
              let candidateOverlap = -Infinity;

              panels.forEach((panel) => {
                const rect = panel.getBoundingClientRect();
                const overlap = Math.min(rect.bottom, window.innerHeight) - Math.max(rect.top, 0);
                const isVisible = overlap > 0;

                panel.classList.toggle('is-visible', isVisible);

                if (!isVisible && panel !== currentActive) {
                  panel.classList.remove('is-exiting');
                }

                if (isVisible && overlap > candidateOverlap) {
                  candidateOverlap = overlap;
                  candidate = panel;
                }
              });

              if (!candidate) {
                candidate = (window.scrollY || window.pageYOffset || 0) <= 0 ? panels[0] : panels[panels.length - 1];
                if (candidate) {
                  candidate.classList.add('is-visible');
                }
              }

              if (candidate) {
                setActive(candidate);
              }
            };

            let ticking = false;
            const queueUpdate = () => {
              if (ticking) return;
              ticking = true;
              requestAnimationFrame(() => {
                updateState();
                ticking = false;
              });
            };

            const observer = new IntersectionObserver(
              () => queueUpdate(),
              { threshold: 0.1, rootMargin: '-15% 0px -15%' }
            );

            panels.forEach((panel) => observer.observe(panel));

            queueUpdate();

            window.addEventListener('scroll', queueUpdate, { passive: true });
            window.addEventListener('resize', queueUpdate);
          }
        }

        const header = document.querySelector('[data-header]');
        if (header) {
          const updateHeader = () => {
            header.classList.toggle('is-scrolled', window.scrollY > 24);
          };

          let headerTicking = false;
          window.addEventListener(
            'scroll',
            () => {
              if (headerTicking) return;
              headerTicking = true;
              requestAnimationFrame(() => {
                updateHeader();
                headerTicking = false;
              });
            },
            { passive: true }
          );

          updateHeader();
        }
      })();
    </script>
  </body>
</html>
